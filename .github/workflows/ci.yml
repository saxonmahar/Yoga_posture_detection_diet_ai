name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Clear npm cache
      run: npm cache clean --force
        
    - name: Install root dependencies
      run: |
        npm install --legacy-peer-deps --no-audit --no-fund
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm install --legacy-peer-deps --no-audit --no-fund
        
    - name: Install backend dependencies
      run: |
        cd backend
        npm install --legacy-peer-deps --no-audit --no-fund
        
    - name: Validate package.json files
      run: |
        echo "âœ… Validating package.json files..."
        node -e "console.log('Root:', JSON.parse(require('fs').readFileSync('package.json', 'utf8')).name)"
        node -e "console.log('Frontend:', JSON.parse(require('fs').readFileSync('frontend/package.json', 'utf8')).name)"
        node -e "console.log('Backend:', JSON.parse(require('fs').readFileSync('backend/package.json', 'utf8')).name)"
        echo "âœ… All package.json files are valid!"
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Verify build artifacts
      run: |
        if [ -d "frontend/dist" ]; then
          echo "âœ… Build successful - dist folder created"
          echo "Build artifacts:"
          ls -la frontend/dist/
          echo "âœ… Frontend build completed successfully!"
        else
          echo "âŒ Build failed - no dist folder found"
          exit 1
        fi
        
    - name: Test backend syntax
      run: |
        cd backend
        if [ -f "index.js" ]; then
          node -c index.js
          echo "âœ… Backend syntax check passed"
        else
          echo "âš ï¸ Backend index.js not found, skipping syntax check"
        fi
        
    - name: Build summary
      run: |
        echo "ğŸ‰ Build Summary:"
        echo "âœ… Dependencies installed successfully"
        echo "âœ… Frontend build completed"
        echo "âœ… All checks passed"
        echo "ğŸš€ Ready for deployment!"